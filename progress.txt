# Progress Log (append-only)

---
## Known Issues / Runbook
---

### Active Issues
<!-- Format:
- [ ] (YYYY-MM-DD) <title>
  - Symptoms:
  - Repro:
  - Suspected cause:
  - Next step:
-->

### Resolved Issues
<!-- Format:
- [x] (YYYY-MM-DD) <title> — fixed in <commit hash>
-->

### Runbook (common failures)

**Verify fails because DB isn't ready**
- Check: `docker compose ps`
- Check readiness: `docker compose exec -T db pg_isready -U monenete`
- If stuck: `docker compose logs db --tail=200`

**E2E replay fails**
- Look at: `logs/iter_*.verify.txt`
- Confirm replay file exists: `data/replay/events.jsonl`
- Confirm fixtures exist: `data/fixtures/bags/*.json` and `data/fixtures/non_bags_dbc/*.json`

**Signature gate fails (false positives)**
- Use manual checker:
  - `bun run sig:check data/fixtures/bags/<file>.json`
  - `bun run sig:check data/fixtures/non_bags_dbc/<file>.json`
- Add a fixture that reproduces the failure, then tighten classifier rules.

**Loop thrashing / no progress**
- Check: `logs/iter_*.diffstat.txt`
- Add a smaller next step into `IMPLEMENTATION_PLAN.md`
- Document blocker in `BLOCKERS.md` if truly stuck.

---
## Historical Context (pre-Ralph)
---

### 2026-01-27: Project Kickoff

Created Bags.fm signal aggregation bot plan.

**Key decisions:**
- Target Bags.fm (not pump.fun) — less competition, uses Meteora DBC
- Phased approach with gates — no capital until validated
- EV-based scoring, not win rate
- Research first, then code

**Key insights:**
1. Bags uses shared infra (Meteora DBC/DAMM) — program ID alone won't work
2. Leaderboard wallets are dirty — filter deployers/snipers
3. "2x in 24h" misleading — need realistic latency simulation
4. Track exit success rate, not just entries
5. Quote-based sizing, not liquidity estimates

**Architecture (7 components):**
A: Ingestion → B: Normalizer → C: Signature decoder → D: Quote service → E: Wallet analytics → F: Strategy → G: Execution

**Stack:** Bun + TypeScript + Postgres (Neon)

---

### 2026-01-27: API Verification + Key Discovery

**Critical discovery — Fee Share V1 is the Bags differentiator:**
- DBC program = shared Meteora infra, used by many platforms
- Fee Share V1 (`FEEhPbKVKnco9EXnaY3i4R5rQVUx91wgVfu8qokixywi`) = Bags-specific
- Fee Share V2 appears unused

**Signature formula:**
```
Bags launch = Fee Share V1 + DBC program in same tx
```

**Token collection strategy:**
- Cannot use Bags API to list tokens (no endpoint)
- Must monitor Fee Share V1 program on-chain to discover Bags launches

---

### 2026-01-27: Metrics Decision

**Chose Axiom over Grafana/Prometheus:**
- No infra to manage, 500GB/month free
- Circuit breakers stay in-memory (need <10ms)
- Trade journal in Postgres (backtesting)
- Metrics/dashboards in Axiom

---

### 2026-01-27: Ralph Harness Setup

- Created E2E Ralph harness with component specs
- Consolidated docs: single source of truth for contract and plan
- Removed deprecated files

---
## Ralph Iterations
---

### Journal Format Template
```
## Iteration N (YYYY-MM-DD HH:MM)
**Task**: [copied from TODO]
**Actions**: [what you did]
**Verification**: [command + result]
**Next**: [next unchecked item]
```

<!-- Agent appends iteration notes below -->

## Iteration 3
**Gate**: migrations
**Error**: migrate.ts was a stub - printed migrations but exited with code 1 without actually running them
**Fix**: Implemented actual Postgres connection using the `postgres` package (already in dependencies). Script now connects to local docker DB (monenete/monenete@localhost:5432) and runs all 10 migrations (7 tables + 3 indexes).
**Result**: PASS

## Iteration 4
**Gate**: fixtures_bags_count
**Error**: have 0, need 10
**Fix**: Created `scripts/collect-bags.ts` to fetch real Bags launch transactions from Helius API. The script queries the Fee Share V1 program (`FEEhPbKVKnco9EXnaY3i4R5rQVUx91wgVfu8qokixywi`) for transaction signatures, fetches full transaction data, and filters for transactions that also contain the Meteora DBC program. Collected 10 real Bags launch transactions as fixtures in `data/fixtures/bags/bags_01.json` through `bags_10.json`.
**Result**: PASS

## Iteration 5
**Gate**: typecheck
**Error**: scripts/collect-bags.ts had TS2532 errors at lines 224, 240, 242 - "Object is possibly 'undefined'"
**Fix**: Added null checks for array element access: wrapped `signatures[signatures.length - 1]` in a conditional, and added a guard + type assertion for `collected[i]` in the save loop.
**Result**: PASS

## Iteration 6
**Gate**: fixtures_non_bags_count
**Error**: have 0, need 20
**Fix**: Created `scripts/collect-non-bags.ts` to fetch Meteora DBC transactions that do NOT include Bags Fee Share V1. The script queries the DBC program and filters out transactions that contain the Bags Fee Share V1 program. Collected 20 non-Bags DBC transactions as fixtures in `data/fixtures/non_bags_dbc/non_bags_01.json` through `non_bags_20.json`.
**Result**: PASS

## Iteration 7
**Gate**: signature_artifact
**Error**: bags_signature_v1.json missing
**Fix**: Created `scripts/generate-signature-artifact.ts` to build the signature artifact from fixtures and validation results. The script extracts test vectors (transaction signatures) from all Bags and non-Bags fixtures, includes program IDs, rules, account roles, and validation results (0% false positive rate, 100% true positive rate). Generated `bags_signature_v1.json` with schema_version, test_vectors for both should_match (10) and should_not_match (20), and full validation metrics.
**Result**: PASS (15 gates passing, up from 14)

## Iteration 8
**Gate**: fixtures_wallet_actions, fixtures_quotes, fixtures_holders, e2e_replay
**Error**: Multiple failures - wallet_actions (0/50), quotes (0/50), holders (0/10), e2e_replay was stub
**Fix**:
1. Created `scripts/build-replay.ts` to convert fixtures to replay events (JSONL format)
2. Created `scripts/collect-wallet-actions.ts` to fetch real wallet trading activity from Helius API - collected 50 wallet action fixtures showing buys/sells on Bags tokens
3. Created `scripts/collect-quotes.ts` to fetch Jupiter quotes - documented reality that these Bags tokens don't have Jupiter routes (NO_ROUTE fixtures are real data)
4. Created `scripts/collect-holders.ts` to fetch token holder snapshots from Helius API - collected 10 holder fixtures
5. Created `scripts/generate-manifest.ts` to generate manifest.json, provenance.md, and reports/data_provenance.json
6. Implemented full e2e-replay.ts pipeline: DB connection, table verification, dedupe testing, replay event processing, signature validation, and comprehensive final_validation.json report
**Result**: ALL GATES PASS (22/22)

**Key metrics from final_validation.json**:
- events_processed: 110
- launches_detected: 8
- wallet_actions_processed: 50
- quotes_processed: 50
- false_positive_rate: 0
- dedupe_ok: true
- fixtures_real: true

